#cloud-config
#
# Instalação automatizada do Zabbix com PostgreSQL + TimescaleDB
# Ubuntu Server 22.04 LTS via Multipass
# Autor: Helton Medeiros
# Data: 20 de junho de 2025

hostname: zabbix
manage_etc_hosts: true
package_update: true
package_upgrade: true

packages:
  - wget
  - gnupg
  - postgresql
  - postgresql-contrib
  - ufw
  - fping

runcmd:
  # Repositório Zabbix
  - wget https://repo.zabbix.com/zabbix/7.4/release/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_7.4+ubuntu22.04_all.deb
  - dpkg -i zabbix-release_latest_7.4+ubuntu22.04_all.deb
  - apt update

  # Instalação Zabbix + TimescaleDB
  - apt install -y zabbix-server-pgsql zabbix-frontend-php php8.1-pgsql zabbix-apache-conf zabbix-sql-scripts zabbix-agent postgresql postgresql-contrib fping mosquitto-clients


  # Configuração do PostgreSQL
  - systemctl enable postgresql
  - systemctl start postgresql
  - sudo -u postgres psql -c "CREATE DATABASE zabbix;"
  - sudo -u postgres psql -c "CREATE USER zabbix WITH PASSWORD 'IoT@zabbix';"
  - sudo -u postgres psql -c "GRANT ALL PRIVILEGES ON DATABASE zabbix TO zabbix;"

  # Otimização TimescaleDB
  # - timescaledb-tune --quiet --yes

  # Importação do schema do Zabbix
  - zcat /usr/share/zabbix/sql-scripts/postgresql/server.sql.gz | sudo -u postgres psql zabbix

  # Concessão de permissões completas para o usuário zabbix
  - sudo -u postgres psql -d zabbix -c "GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO zabbix;"
  - sudo -u postgres psql -d zabbix -c "GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO zabbix;"
  - sudo -u postgres psql -d zabbix -c "GRANT ALL PRIVILEGES ON ALL FUNCTIONS IN SCHEMA public TO zabbix;"
  - sudo -u postgres psql -d zabbix -c "ALTER DEFAULT PRIVILEGES IN SCHEMA public GRANT ALL ON TABLES TO zabbix;"

  # Configurar senha no arquivo de config do Zabbix
  - sed -i 's/^# DBPassword=/DBPassword=IoT@zabbix/' /etc/zabbix/zabbix_server.conf

  # Iniciar e habilitar serviços
  - systemctl restart zabbix-server
  - systemctl restart apache2
  - systemctl restart zabbix-agent
  - systemctl enable zabbix-server
  - systemctl enable apache2
  - systemctl enable zabbix-agent

  # Configuração do firewall
  - ufw allow 22
  - ufw allow 80
  - ufw allow 10050
  - ufw allow 10051
  - ufw allow 3000
  - ufw --force enable

  # Instalação do Grafana
  - sudo apt-get install -y adduser libfontconfig1 musl
  - wget https://dl.grafana.com/enterprise/release/grafana-enterprise_12.1.0_amd64.deb
  - sudo dpkg -i grafana-enterprise_12.1.0_amd64.deb
  - systemctl daemon-reexec
  - systemctl daemon-reload
  - systemctl enable grafana-server
  - systemctl start grafana-server
  - grafana-cli plugins install alexanderzobnin-zabbix-app
  - systemctl restart grafana-server

  # Configuração de IP fixo (substitua conforme necessário)
  - |
    bash -c '
          echo "Configurando rede com IP fixo...";
      wget --retry-connrefused --waitretry=1 --tries=10 https://raw.githubusercontent.com/heltonpierre/airquality-iot-platform/refs/heads/main/provisioning/scripts/config-ip-static.sh;
      chmod +x config-ip-static.sh;
      ./config-ip-static.sh 10.33.33.100/24;
      rm -f config-ip-static.sh;
    '
