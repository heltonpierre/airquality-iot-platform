# cloud-config
#
# Configura√ß√£o do Node-RED com IP atribu√≠do por DHCP e acesso SSH
# Autor: Helton Medeiros
# Local: Campina Grande - PB, Brasil
# Data: 19 de junho de 2025
# Requisitos: Ubuntu Server 22.04 LTS ou superior (Multipass/QEMU)
#

hostname: node-red
manage_etc_hosts: true
package_update: true
package_upgrade: true

# Pacotes necess√°rios
packages:
  - snapd
  - ufw

# Comandos para executar na inicializa√ß√£o
runcmd:
  - snap install node-red
  - ufw allow 22
  - ufw allow 1880
  - ufw --force enable

  # Configura√ß√£o de IP fixo (substitua conforme necess√°rio)
  - |
    bash -c '
          echo "Configurando rede com IP fixo...";
      wget --retry-connrefused --waitretry=1 --tries=10 https://raw.githubusercontent.com/heltonpierre/airquality-iot-platform/refs/heads/main/provisioning/scripts/config-ip-static.sh;
      chmod +x config-ip-static.sh;
      ./config-ip-static.sh 10.33.33.50/24;
      rm -f config-ip-static.sh;
    '

  # Baixar e executar o script de download de datasets
  - |
    bash -c '
      wget https://raw.githubusercontent.com/heltonpierre/airquality-iot-platform/refs/heads/main/node-red/download_dataset.sh;
      wget https://raw.githubusercontent.com/heltonpierre/airquality-iot-platform/refs/heads/main/node-red/download_all_dataset.sh;
      chmod +x download_dataset.sh download_all_dataset.sh;
      rm -f download_dataset.sh download_all_dataset.sh;
      ./download_all_dataset.sh;
    '

final_message: |
  ‚úÖ Provisionamento conclu√≠do!
  üîê SSH liberado na porta 22
  üåê Acesse o Node-RED via IP atribu√≠do por DHCP na porta 1880
