# cloud-config
#
# Provisionamento do Mosquitto Broker no Ubuntu 22.04 via cloud-init
# Autor: Helton Medeiros
# Local: Campina Grande - PB, Brasil
# Data: 19 de junho de 2025 (revisado em agosto de 2025)
# Requisitos: Ubuntu Server 22.04 LTS ou superior (Multipass/QEMU)
#

hostname: mqtt-gateway
manage_etc_hosts: true
package_update: true
package_upgrade: true

packages:
  - mosquitto
  - mosquitto-clients
  - wget

runcmd:
  - |
    bash -c '
      echo "‚è≥ Aguardando conectividade de rede...";
      until ping -c1 8.8.8.8 > /dev/null 2>&1; do sleep 3; done;

      echo "üîß Habilitando servi√ßo Mosquitto...";
      systemctl enable mosquitto;

      echo "üì¶ Backup do mosquitto.conf original...";
      mv /etc/mosquitto/mosquitto.conf /etc/mosquitto/mosquitto.conf.backup || true;

      echo "‚¨áÔ∏è Baixando arquivos de configura√ß√£o...";
      wget --retry-connrefused --waitretry=1 --tries=10 -O /etc/mosquitto/mosquitto.conf https://raw.githubusercontent.com/heltonpierre/airquality-iot-platform/main/mosquitto/mosquitto.conf;
      wget --retry-connrefused --waitretry=1 --tries=10 -O /etc/mosquitto/acl https://raw.githubusercontent.com/heltonpierre/airquality-iot-platform/main/mosquitto/acl;

      echo "‚úÖ Verificando arquivos...";
      if [ ! -f /etc/mosquitto/mosquitto.conf ]; then echo "‚ùå ERRO: mosquitto.conf n√£o foi baixado."; exit 1; fi;
      if [ ! -f /etc/mosquitto/acl ]; then echo "‚ùå ERRO: acl n√£o foi baixado."; exit 1; fi;

      echo "üîê Criando usu√°rios Mosquitto...";
      mosquitto_passwd -c -b /etc/mosquitto/mosquitto_passwd zabbix senha@123;
      for i in 01 02 03 04 05 06; do
        mosquitto_passwd -b /etc/mosquitto/mosquitto_passwd device$i device@$i;
      done;
      chown mosquitto: /etc/mosquitto/mosquitto_passwd;
      chmod 640 /etc/mosquitto/mosquitto_passwd;

      echo "üîÑ Reiniciando Mosquitto...";
      systemctl restart mosquitto;
    '
