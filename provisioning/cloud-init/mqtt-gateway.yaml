# cloud-config
#
# Provisionamento do Mosquitto Broker no Ubuntu 22.04 via cloud-init
# Autor: Helton Medeiros
# Local: Campina Grande - PB, Brasil
# Data: 19 de junho de 2025
# Requisitos: Ubuntu Server 22.04 LTS ou superior (Multipass/QEMU)
#

hostname: mqtt-gateway
manage_etc_hosts: true
package_update: true
package_upgrade: true

packages:
  - mosquitto
  - mosquitto-clients
  - wget

runcmd:
  # Habilita o serviço Mosquitto
  - systemctl enable mosquitto

  # Backup do arquivo original (por segurança)
  - mv /etc/mosquitto/mosquitto.conf /etc/mosquitto/mosquitto.conf.backup

  # Baixa o novo arquivo de configuração
  - sudo wget -O /etc/mosquitto/mosquitto.conf https://raw.githubusercontent.com/heltonpierre/airquality-iot-platform/refs/heads/main/mosquitto/mosquitto.conf
  - sudo wget -O /etc/mosquitto/acl https://raw.githubusercontent.com/heltonpierre/airquality-iot-platform/refs/heads/main/mosquitto/acl

  # Criar usuários e senhas para autenticação dos dispositivos e Zabbix
  - sudo mosquitto_passwd -c -b /etc/mosquitto/mosquitto_passwd zabbix senha@123
  - sudo mosquitto_passwd -b /etc/mosquitto/mosquitto_passwd device01 device@01
  - sudo mosquitto_passwd -b /etc/mosquitto/mosquitto_passwd device02 device@02
  - sudo mosquitto_passwd -b /etc/mosquitto/mosquitto_passwd device03 device@03
  - sudo mosquitto_passwd -b /etc/mosquitto/mosquitto_passwd device04 device@04
  - sudo mosquitto_passwd -b /etc/mosquitto/mosquitto_passwd device05 device@05
  - sudo mosquitto_passwd -b /etc/mosquitto/mosquitto_passwd device06 device@06
  - sudo chown mosquitto: /etc/mosquitto/mosquitto_passwd
  - sudo chmod 640 /etc/mosquitto/mosquitto_passwd

  # Reinicia o serviço para aplicar a nova configuração
  - systemctl restart mosquitto
