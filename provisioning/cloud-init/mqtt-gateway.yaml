# cloud-config
#
# Provisionamento do Mosquitto Broker no Ubuntu 22.04 via cloud-init
# Autor: Helton Medeiros
# Local: Campina Grande - PB, Brasil
# Data: 19 de junho de 2025 (revisado em agosto de 2025)
# Requisitos: Ubuntu Server 22.04 LTS ou superior (Multipass/QEMU)
#

hostname: mqtt-gateway
manage_etc_hosts: true
package_update: true
package_upgrade: true

# Configuração de pacotes
packages:
  - mosquitto
  - mosquitto-clients
  - wget

# run commands
runcmd:
  - |
    bash -c '
      echo "Aguardando conectividade de rede...";
      until ping -c1 8.8.8.8 > /dev/null 2>&1; do sleep 3; done;

      echo "Habilitando serviço Mosquitto...";
      systemctl enable mosquitto;

      echo "Backup do mosquitto.conf original...";
      mv /etc/mosquitto/mosquitto.conf /etc/mosquitto/mosquitto.conf.backup || true;

      echo "Baixando arquivos de configuração...";
      wget --retry-connrefused --waitretry=1 --tries=10 -O /etc/mosquitto/mosquitto.conf https://raw.githubusercontent.com/heltonpierre/airquality-iot-platform/refs/heads/main/mqtt-gateway/mosquitto.conf;
      wget --retry-connrefused --waitretry=1 --tries=10 -O /etc/mosquitto/acl https://raw.githubusercontent.com/heltonpierre/airquality-iot-platform/refs/heads/main/mqtt-gateway/acl;

      echo "Verificando arquivos...";
      if [ ! -f /etc/mosquitto/mosquitto.conf ]; then echo "❌ ERRO: mosquitto.conf não foi baixado."; exit 1; fi;
      if [ ! -f /etc/mosquitto/acl ]; then echo "❌ ERRO: acl não foi baixado."; exit 1; fi;

      echo "Criando usuários Mosquitto...";
      mosquitto_passwd -c -b /etc/mosquitto/mosquitto_passwd zabbix senha@123;
      for i in 01 02 03 04 05 06; do
        mosquitto_passwd -b /etc/mosquitto/mosquitto_passwd device$i device@$i;
      done;
      chown mosquitto: /etc/mosquitto/mosquitto_passwd;
      chmod 640 /etc/mosquitto/mosquitto_passwd;

      echo "Reiniciando Mosquitto...";
      systemctl restart mosquitto;

      # echo "Instalando Zabbix Agent...";
      wget https://repo.zabbix.com/zabbix/7.4/release/ubuntu/pool/main/z/zabbix-release/zabbix-release_latest_7.4+ubuntu22.04_all.deb;
      dpkg -i zabbix-release_latest_7.4+ubuntu22.04_all.deb;
      apt update;
      apt install -y zabbix-agent2;

      # echo "Configurando Zabbix Agent...";
      mv /etc/zabbix/zabbix_agent2.conf /etc/zabbix/zabbix_agent2.conf.backup;
      wget --retry-connrefused --waitretry=1 --tries=10 -O /etc/zabbix/zabbix_agent2.conf https://raw.githubusercontent.com/heltonpierre/airquality-iot-platform/refs/heads/main/mqtt-gateway/zabbix_agent2.conf;
      wget https://raw.githubusercontent.com/heltonpierre/airquality-iot-platform/refs/heads/main/mqtt-gateway/agent2_mqtt-gateway.psk;
      sudo systemctl restart zabbix-agent2.service;

      echo "Configurando rede com IP fixo...";
      wget --retry-connrefused --waitretry=1 --tries=10 https://raw.githubusercontent.com/heltonpierre/airquality-iot-platform/refs/heads/main/provisioning/scripts/config-ip-static.sh;
      chmod +x config-ip-static.sh;
      ./config-ip-static.sh 10.33.33.10/24;
      rm -f config-ip-static.sh;
    '